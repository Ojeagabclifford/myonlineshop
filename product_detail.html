<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .stat-box { border: 1px solid #e2e8f0; }
        .detail-header { background-color: #2563eb; }
        .stat-label { font-weight: 500; }

        /* Toast Animationa */
        #toast { transition: opacity 0.5s ease-in-out; }
        .toast-visible { opacity: 1; transform: translateY(0); }
        .toast-hidden { opacity: 0; transform: translateY(20px); pointer-events: none; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.7); }
    </style>
</head>
<body>

    <!-- HEADER (Navigation) -->
    <div class="bg-white p-4 shadow-md sticky top-0 z-10">
        <div class="container mx-auto flex justify-between items-center">
            <button onclick="window.location.href='index.html'" class="text-blue-600 mr-4">
                <i class="fas fa-arrow-left fa-lg"></i>
            </button>
            <h1 class="text-xl font-bold text-gray-800 flex-1">Product Detail</h1>
            
            <!-- Cart Icon -->
            <button onclick="toggleCart()" class="relative bg-blue-700 p-2 rounded-full text-white">
                <i class="fas fa-shopping-cart"></i>
                <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-xs w-5 h-5 flex items-center justify-center rounded-full hidden">0</span>
            </button>
        </div>
    </div>

    <!-- MAIN DETAIL CONTENT -->
    <!-- FIX: Applied max-w-lg (large max width) for better desktop viewing -->
    <div id="detail-content" class="container mx-auto p-4 max-w-lg">
        <div id="loader" class="text-center text-gray-500 mt-10">
            <i class="fas fa-spinner fa-spin fa-2x"></i><br>Fetching Details...
        </div>
        <!-- Details will be injected here -->
    </div>

    <!-- ADD TO CART FIXED FOOTER -->
    <div id="fixed-footer" class="fixed bottom-0 left-0 right-0 bg-white p-4 shadow-2xl border-t hidden">
        <div class="container mx-auto max-w-lg flex justify-between items-center">
            <span id="detail-price" class="text-2xl font-bold text-green-600"></span>
            <button id="add-to-cart-btn" class="bg-blue-600 text-white py-3 px-6 rounded-lg font-bold shadow hover:bg-blue-700 disabled:opacity-50">
                <i class="fas fa-cart-plus mr-2"></i> Add to Cart
            </button>
        </div>
    </div>
    
    <!-- CART MODAL (Duplicated from index.html) -->
    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-end sm:items-center z-50">
        <div class="bg-white w-full sm:w-96 rounded-t-xl sm:rounded-xl p-5 shadow-2xl h-3/4 flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-bold">Your Cart ðŸ›’</h2>
                <button onclick="toggleCart()" class="text-gray-500"><i class="fas fa-times fa-lg"></i></button>
            </div>
            
            <div id="cart-items" class="flex-1 overflow-y-auto space-y-3">
                <p class="text-gray-400 text-center mt-10">Your cart is empty.</p>
            </div>

            <div class="border-t pt-4 mt-4">
                <div class="flex justify-between text-lg font-bold mb-4">
                    <span>Total:</span>
                    <span id="cart-total" class="text-green-600">â‚¦0</span>
                </div>
                <button onclick="checkoutWhatsApp()" class="w-full bg-green-500 text-white py-3 rounded-lg font-bold shadow hover:bg-green-600">
                    <i class="fab fa-whatsapp"></i> Order via WhatsApp
                </button>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg z-50 toast-hidden flex items-center">
        <i class="fas fa-check-circle text-green-400 mr-2"></i>
        <span id="toast-message">Item added to cart</span>
    </div>


    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCiOhrie12s0BjLEcZo6WUMyf2r5DN7EPs",
            authDomain: "mybusinessapp-6e078.firebaseapp.com",
            projectId: "mybusinessapp-6e078",
            storageBucket: "mybusinessapp-6e078.firebasestorage.app",
            messagingSenderId: "34868859116",
            appId: "1:34868859116:web:ed9a6fe4100962f65495c9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const STORE_CURRENCY = 'â‚¦';
        const CART_KEY = 'ojeaga_cart'; 

        let currentProduct = null;
        let storeConfig = { whatsappNumber: "2347044649784", name: "Ojeaga's Digital Store" }; 
        let cart = []; // Must be initialized for cart functions to work

        // --- UTILITY FUNCTIONS (COPIED FROM INDEX.HTML) ---

        function loadCart() {
            try {
                const savedCart = localStorage.getItem(CART_KEY);
                if (savedCart) cart = JSON.parse(savedCart);
            } catch (e) { console.error("Error loading cart:", e); }
        }

        function saveCart() {
            try { localStorage.setItem(CART_KEY, JSON.stringify(cart)); } catch (e) { console.error("Error saving cart:", e); }
        }
        
        function getImagePath(productName) {
            const cleanName = productName.toLowerCase().replace(/[^a-z0-9]/g, '');
            return `images/${cleanName}.jpg`;
        }

        // FIX: Toast Notification Logic
        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').innerText = msg;
            toast.classList.remove('toast-hidden');
            toast.classList.add('toast-visible');
            setTimeout(() => {
                toast.classList.remove('toast-visible');
                toast.classList.add('toast-hidden');
            }, 2000);
        }

        window.toggleCart = () => {
            document.getElementById('cart-modal').classList.toggle('hidden');
        };
        
        window.addToCart = (id, showNotification = false) => {
            // NOTE: On this detail page, we assume currentProduct is the target.
            if (!currentProduct || currentProduct.id !== id) {
                showToast('Error: Product data missing.'); 
                return;
            }
            
            const product = currentProduct;
            const existing = cart.find(c => c.id === id);
            
            if (existing) {
                if (existing.qty < product.stock) {
                    existing.qty++;
                    showToast(`Added another ${product.name}`);
                } else {
                    showToast("Max stock reached!");
                }
            } else {
                cart.push({ ...product, qty: 1 });
                showToast(`${product.name} added to cart!`);
            }
            updateCartUI();
            saveCart();
            renderDetails(currentProduct); // Re-render to update the Quantity in Cart stat
        };

        window.decreaseQty = (id) => {
            const existing = cart.find(c => c.id === id);
            if (existing) {
                if (existing.qty > 1) {
                    existing.qty--;
                } else {
                    cart = cart.filter(c => c.id !== id);
                }
                updateCartUI();
                saveCart();
            }
        };

        window.removeFromCart = (id) => {
            cart = cart.filter(c => c.id !== id);
            updateCartUI();
            saveCart();
        };

        window.checkoutWhatsApp = () => {
            if (cart.length === 0) return showToast("Cart is empty!");
            
            if (!storeConfig.whatsappNumber || storeConfig.whatsappNumber.length < 10) {
                return showToast("Store owner has not set a valid phone number.");
            }

            let msg = `Hello ${storeConfig.name}, I want to order:%0A%0A`;
            let total = 0;
            cart.forEach(item => {
                const sub = item.sellPrice * item.qty;
                total += sub;
                msg += `â–ªï¸ ${item.name} (x${item.qty}) - ${STORE_CURRENCY}${sub.toLocaleString()}%0A`;
            });
            msg += `%0A*TOTAL: ${STORE_CURRENCY}${total.toLocaleString()}*`;
            msg += "%0A%0APlease confirm availability.";
            window.open(`https://wa.me/${storeConfig.whatsappNumber}?text=${msg}`, '_blank');
        };

        function updateCartUI() {
            const cartDiv = document.getElementById('cart-items');
            const badge = document.getElementById('cart-count');
            const totalEl = document.getElementById('cart-total');
            
            const totalQty = cart.reduce((acc, c) => acc + c.qty, 0);
            badge.innerText = totalQty;
            badge.classList.toggle('hidden', totalQty === 0);

            cartDiv.innerHTML = "";
            let total = 0;

            if (cart.length === 0) {
                cartDiv.innerHTML = "<p class='text-gray-400 text-center mt-10'>Your cart is empty.</p>";
            } else {
                // Simplified display for cart items
                cart.forEach(item => {
                    const itemTotal = item.sellPrice * item.qty;
                    total += itemTotal;
                    cartDiv.innerHTML += `
                        <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                            <div class="flex-1">
                                <p class="font-bold text-sm">${item.name}</p>
                                <div class="flex items-center mt-1">
                                    <p class="text-xs text-gray-500 mr-2">${STORE_CURRENCY}${item.sellPrice}</p>
                                    
                                    <!-- QUANTITY CONTROLS -->
                                    <div class="flex items-center border rounded bg-white w-max">
                                        <button onclick="decreaseQty('${item.id}')" class="px-2 py-0 text-gray-600 hover:bg-gray-100">-</button>
                                        <span class="px-2 text-xs font-bold">${item.qty}</span>
                                        <button onclick="addToCart('${item.id}', false)" class="px-2 py-0 text-gray-600 hover:bg-gray-100">+</button>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <span class="font-bold text-sm mr-3">${STORE_CURRENCY}${itemTotal.toLocaleString()}</span>
                                <button onclick="removeFromCart('${item.id}')" class="text-red-500 hover:text-red-700 ml-2">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            totalEl.innerText = STORE_CURRENCY + total.toLocaleString();
        }
        // --- END UTILITY ---


        async function initDetail() {
            loadCart();
            updateCartUI(); 

            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('pid');

            const detailContent = document.getElementById('detail-content');
            const loaderEl = document.getElementById('loader');
            
            if (!productId) {
                detailContent.innerHTML = '<p class="text-red-500 text-center mt-10">Error: No product ID specified.</p>';
                loaderEl.remove();
                return;
            }

            try {
                // Fetch Single Document from Firestore
                const docRef = doc(db, "products", productId);
                const docSnap = await getDoc(docRef);

                loaderEl.remove();

                if (docSnap.exists()) {
                    currentProduct = { id: docSnap.id, ...docSnap.data() };
                    renderDetails(currentProduct);
                } else {
                    detailContent.innerHTML = '<p class="text-red-500 text-center mt-10">Product not found.</p>';
                }

            } catch (e) {
                console.error("CRITICAL ERROR:", e);
                loaderEl.remove();
                detailContent.innerHTML = '<p class="text-red-500 text-center mt-10">Failed to connect to load product details.</p>';
            }
        }

        function renderDetails(p) {
            const detailContent = document.getElementById('detail-content');
            const detailPrice = document.getElementById('detail-price');
            const fixedFooter = document.getElementById('fixed-footer');
            const cartBtn = document.getElementById('add-to-cart-btn');

            const isOutOfStock = p.stock <= 0;
            
            // Image source logic
            let imageSrc = p.image; 
            if (!imageSrc || imageSrc.startsWith('file')) {
                imageSrc = getImagePath(p.name);
            }
            const isBase64 = imageSrc && imageSrc.startsWith('data:image');
            const isHttp = imageSrc && imageSrc.startsWith('http');
            const currentQty = (cart.find(item => item.id === p.id)?.qty || 0);

            detailContent.innerHTML = `
                <div class="mb-6">
                    <div class="h-64 bg-gray-200 flex items-center justify-center overflow-hidden rounded-lg">
                        ${(isBase64 || isHttp || imageSrc.startsWith('images/')) ? 
                            `<img src="${imageSrc}" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='https://placehold.co/300x250/f0f0f0/ccc?text=Image+Error';">` : 
                            `<i class="fas fa-box-open text-gray-400 fa-4x"></i>`
                        }
                    </div>
                </div>
                
                <h1 class="text-3xl font-bold text-gray-900 mb-2">${p.name}</h1>
                <span class="text-sm bg-blue-100 text-blue-600 px-3 py-1 rounded-full font-semibold">${p.category}</span>
                
                <!-- Description -->
                <h3 class="font-bold text-gray-800 mt-4 mb-2">Product Description</h3>
                <p class="text-gray-700 leading-relaxed p-3 bg-white rounded-lg border border-gray-200">${p.description || 'No detailed description available.'}</p>

                <!-- STATS -->
                <div class="grid grid-cols-2 gap-4 mt-8 mb-6">
                    <div class="stat-box p-3 rounded-lg text-center bg-white">
                        <p class="text-xs text-gray-500 uppercase stat-label">Available Stock</p>
                        <p class="text-xl font-bold ${isOutOfStock ? 'text-red-600' : 'text-blue-600'}">${p.stock} Units</p>
                    </div>
                    <div class="stat-box p-3 rounded-lg text-center bg-white">
                        <p class="text-xs text-gray-500 uppercase stat-label">Quantity in Cart</p>
                        <p class="text-xl font-bold text-purple-600">${currentQty}</p>
                    </div>
                </div>
                
                <!-- Pricing Information (Removed Cost Price for public view) -->
                <div class="p-3 bg-gray-100 rounded-lg text-sm mb-2">
                    <p class="text-gray-700 font-semibold">Ready to Order!</p>
                </div>
                <div style="height: 100px;"></div>
            `;
            
            // Update Footer
            detailPrice.innerText = `${STORE_CURRENCY}${p.sellPrice.toLocaleString()}`;
            fixedFooter.classList.remove('hidden');
            
            if (isOutOfStock) {
                cartBtn.innerText = 'SOLD OUT';
                cartBtn.disabled = true;
                cartBtn.classList.add('bg-gray-400');
                cartBtn.classList.remove('bg-blue-600');
            } else {
                cartBtn.innerText = 'ADD TO CART';
                cartBtn.disabled = false;
                cartBtn.classList.remove('bg-gray-400');
                cartBtn.classList.add('bg-blue-600');
            }

            // Attach cart action to the button
            cartBtn.onclick = () => {
                window.addToCart(p.id, true);
                renderDetails(p); // Re-render to update the Quantity in Cart stat
            };
        }

        // Start the process
        initDetail();
    </script>
</body>
</html>